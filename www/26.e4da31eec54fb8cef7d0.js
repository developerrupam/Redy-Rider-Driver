(window.webpackJsonp=window.webpackJsonp||[]).push([[26],{bNZI:function(n,t,o){"use strict";o.r(t);var i=o("CcnG"),e=o("mrSG"),r=o("gTw3"),l=o("ZZ/e"),a=o("23JA"),s=o("UNbJ"),c=o("k82s"),u=o("Ht5U"),p=o("67Y/"),d=function(){function n(n,t,o,i,e,r,l,a,s,c,u){var p=this;this.navCtrl=n,this.plt=t,this.geolocation=o,this.storage=i,this.nativeGeocoder=e,this.backgroundGeolocation=r,this.afAuth=l,this.afs=a,this.localNotifications=s,this.route=c,this.officePoolCarService=u,this.progress_bar=!1,this.directionsService=new google.maps.DirectionsService,this.directionsDisplay=new google.maps.DirectionsRenderer({suppressMarkers:!0}),this.DirectionsWaypoint=[],this.arr=[],this.user=null,this.currentMapTrack=null,this.markers=[],this.isTracking=!1,this.trackedRoute=[],this.previousTracks=[],this.loc=[],this.geoencoderOptions={useLocale:!0,maxResults:5},this.stoppage_list=[],this.start_location="",this.end_location="",this.car_type="",this.route_id="",this.driver_id="",console.log("constructor"),this.car_id=this.route.snapshot.params.car_id,this.driver_id=this.route.snapshot.params.driver_id,this.storage.get("car_details").then(function(n){n&&n.forEach(function(n){n.car_id==p.car_id&&(p.route_id=n.route_id,p.stoppage_list=n.stoppage_list,p.start_location=n.start_location,p.end_location=n.end_location,p.car_type=n.car_type,p.loadMap({lat:parseFloat(n.start_lat),lng:parseFloat(n.start_long)},{lat:parseFloat(n.end_lat),lng:parseFloat(n.end_long)}),n.stoppage_list_1.forEach(function(n){var t;t={location:{lat:parseFloat(n.location.lat),lng:parseFloat(n.location.lng)},stopover:n.stopover},p.DirectionsWaypoint.push(t)}))})}),this.storage.get("USER_INFO").then(function(n){n&&p.anonLogin(n.user_account_no+"-"+n.name+"-"+new Date)})}return n.prototype.ngOnInit=function(){var n=this;console.log("ngOnInit"),this.backgroundGeolocation.configure({desiredAccuracy:10,stationaryRadius:20,interval:2e3,distanceFilter:30,debug:!0,stopOnTerminate:!1}).then(function(){n.backgroundGeolocation.on(s.b.location).subscribe(function(t){console.log(t),n.driver_current_lat=t.latitude,n.driver_current_lng=t.longitude,n.update_driver_cordinated_to_firebase(),n.backgroundGeolocation.finish()})})},n.prototype.ionViewDidEnter=function(){console.log("ionViewDidEnter"),this.plt.ready().then(function(){})},n.prototype.ionViewWillEnter=function(){console.log("ionViewWillEnter")},n.prototype.loadMap=function(n,t){var o=this;this.map=new google.maps.Map(this.mapElement.nativeElement,{center:{lat:-34.9011,lng:-56.1645},zoom:19,mapTypeId:google.maps.MapTypeId.ROADMAP,disableDefaultUI:!0}),this.geolocation.getCurrentPosition().then(function(n){var t={lat:n.coords.latitude,lng:n.coords.longitude};o.driver_marker=new google.maps.Marker({position:t,map:o.map,icon:"http://tobuekalabya.com/carservice_manage/icon/car_top.png",title:"you are here!"}),o.map.setCenter(t)}).catch(function(n){console.log("Error getting location",n)}),this.directionsDisplay.setMap(this.map),console.log("start_loc",this.start_location),this.location_source=n,this.location_destination=t,this.calculateAndDisplayRoute()},n.prototype.calculateAndDisplayRoute=function(){var n=this,t=this;t.directionsService.route({origin:this.location_source,destination:this.location_destination,travelMode:"DRIVING",waypoints:this.DirectionsWaypoint},function(o,i){"OK"===i?(t.directionsDisplay.setDirections(o),n.stoppage_list.forEach(function(t){var o,i={lat:parseFloat(t.lat),lng:parseFloat(t.lng)},e=new google.maps.InfoWindow({content:String(t.location_name)});o=new google.maps.Marker({position:i,map:n.map,icon:t.icon,title:"you are here!"}),1!=t.start&&1!=t.stop||e.open(n.map,o)})):window.alert("Directions request failed due to "+i)})},n.prototype.anonLogin=function(n){var t=this;this.afAuth.auth.signInAnonymously().then(function(o){t.locationsCollection=t.afs.collection("locations/"+n+"/track",function(n){return n.orderBy("timestamp")}),t.locations=t.locationsCollection.snapshotChanges().pipe(Object(p.a)(function(n){return n.map(function(n){var t=n.payload.doc.data();return e.__assign({id:n.payload.doc.id},t)})})),console.log("this.locations",t.locations),t.locations.subscribe(function(n){console.log("new location: ",n),t.loc=n})})},n.prototype.startTracking=function(){var n=this;if(google.maps.LatLng(this.driver_current_lat,this.driver_current_lng)==this.location_source){this.isTracking=!0,this.geolocation.getCurrentPosition().then(function(t){var o={};o.lat=t.coords.latitude,o.long=t.coords.longitude,o.name="";var i=n.car_type+"-"+n.car_id;n.afs.collection("locations").doc(i).set(o)}).catch(function(n){console.log("Error getting location",n)}),this.backgroundGeolocation.start();var t=1;this.trackedRoute=[],this.watch=this.geolocation.watchPosition({frequency:3e3,enableHighAccuracy:!0}).subscribe(function(o){if(console.log("new position: ",o),o){n.trackedRoute.push({lat:o.coords.latitude,lng:o.coords.longitude,address:n.geoAddress,point_number:t}),t++,n.driver_current_lat=o.coords.latitude,n.driver_current_lng=o.coords.longitude;var i=new google.maps.LatLng(n.driver_current_lat,n.driver_current_lng);console.log(i),n.driver_marker.setPosition(i),n.map.panTo(i),n.update_driver_cordinated_to_firebase()}}),this.sendNotificationToPassengers()}else alert("The Driver must End the ride from the Ending point of the route!")},n.prototype.update_driver_cordinated_to_firebase=function(){var n={};n.lat=this.driver_current_lat,n.long=this.driver_current_lng,n.name="test1.03.2020";var t=this.car_type+"-"+this.car_id;this.afs.collection("locations").doc(t).update(n)},n.prototype.stopTracking=function(){if(google.maps.LatLng(this.driver_current_lat,this.driver_current_lng)==this.location_source){this.isTracking=!1,this.backgroundGeolocation.stop(),this.watch.unsubscribe();var n=this.car_type+"-"+this.car_id;this.afs.collection("locations").doc(n).delete(),this.endJourney()}else alert("The Driver must End the ride from the Ending point of the route!")},n.prototype.sendNotificationToPassengers=function(){var n=this;this.progress_bar=!0;var t={type:"drive_start",route_id:this.route_id,route_timing_id:0,car_id:this.car_id,driver_id:this.driver_id};console.log("request_data",t),this.officePoolCarService.todayRidesService(t).subscribe(function(t){n.storage.set("drive_history_id",t.result.drive_history_id),n.progress_bar=!1},function(t){n.progress_bar=!1})},n.prototype.endJourney=function(){var n=this;this.progress_bar=!0,this.storage.get("drive_history_id").then(function(t){t&&n.officePoolCarService.todayRidesService({type:"drive_end",drive_history_id:t}).subscribe(function(t){n.progress_bar=!1},function(t){n.progress_bar=!1})})},n}(),g=function(){return function(){}}(),h=o("pMnS"),b=o("bAmN"),_=o("oBZk"),f=o("fNgX"),v=o("Hf/j"),y=o("ZYjt"),m=o("jWFl"),k=o("OOyK"),w=o("ZYCi"),T=o("iw74"),P=o("jKJn"),M=o("xoVG"),q=o("ZgVV"),I=o("cGva"),z=o("Ip0R"),D=o("ZBkt"),E=o("fvl4"),C=i.ob({encapsulation:0,styles:[["#map[_ngcontent-%COMP%]{width:100%;height:550px}#markerLayer[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{animation:.5s infinite alternate pulse;-webkit-animation:.5s infinite alternate pulse;transform-origin:center;-webkit-transform-origin:center}.footer-bus-route-details[_ngcontent-%COMP%]{background:#0a5999;color:#fff;text-align:center;padding:0 10px}ion-toolbar[_ngcontent-%COMP%]{--background:transparent;--color:white}"],b.a],data:{}});function L(n){return i.Hb(0,[(n()(),i.qb(0,0,null,null,1,"ion-progress-bar",[["class","progress_bar"],["type","indeterminate"]],null,null,null,_.wb,_.E)),i.pb(1,49152,null,0,l.ab,[i.h,i.k,i.z],{type:[0,"type"]},null)],function(n,t){n(t,1,0,"indeterminate")},null)}function O(n){return i.Hb(0,[(n()(),i.qb(0,0,null,null,5,"ion-col",[["no-margin",""],["style","font-size: 20px;"]],null,[[null,"click"]],function(n,t,o){var i=!0;return"click"===t&&(i=!1!==n.component.startTracking()&&i),i},_.ab,_.i)),i.pb(1,49152,null,0,l.v,[i.h,i.k,i.z],null,null),(n()(),i.qb(2,0,null,0,2,"fa-icon",[["class","rstar-icon ng-fa-icon"],["size","1x"]],[[8,"innerHTML",1]],null,null,f.b,f.a)),i.pb(3,573440,null,0,v.a,[y.c,v.b],{iconProp:[0,"iconProp"],size:[1,"size"]},null),i.Bb(4,2),(n()(),i.Gb(-1,0,[" START "]))],function(n,t){var o=n(t,4,0,"fas","play-circle");n(t,3,0,o,"1x")},function(n,t){n(t,2,0,i.Ab(t,3).renderedIconHTML)})}function x(n){return i.Hb(0,[(n()(),i.qb(0,0,null,null,5,"ion-col",[["no-margin",""],["style","font-size: 20px;"]],null,[[null,"click"]],function(n,t,o){var i=!0;return"click"===t&&(i=!1!==n.component.stopTracking()&&i),i},_.ab,_.i)),i.pb(1,49152,null,0,l.v,[i.h,i.k,i.z],null,null),(n()(),i.qb(2,0,null,0,2,"fa-icon",[["class","rstar-icon ng-fa-icon"],["size","1x"]],[[8,"innerHTML",1]],null,null,f.b,f.a)),i.pb(3,573440,null,0,v.a,[y.c,v.b],{iconProp:[0,"iconProp"],size:[1,"size"]},null),i.Bb(4,2),(n()(),i.Gb(-1,0,[" STOP "]))],function(n,t){var o=n(t,4,0,"fas","stop-circle");n(t,3,0,o,"1x")},function(n,t){n(t,2,0,i.Ab(t,3).renderedIconHTML)})}function A(n){return i.Hb(0,[i.Eb(402653184,1,{mapElement:0}),(n()(),i.qb(1,0,null,null,1,"app-header",[],null,null,null,m.b,m.a)),i.pb(2,114688,null,0,k.a,[w.m,l.f,T.b,P.a,M.a,u.a,q.a,I.a],null,null),(n()(),i.hb(16777216,null,null,1,null,L)),i.pb(4,16384,null,0,z.j,[i.P,i.L],{ngIf:[0,"ngIf"]},null),(n()(),i.qb(5,0,null,null,2,"ion-content",[],null,null,null,_.bb,_.j)),i.pb(6,49152,null,0,l.w,[i.h,i.k,i.z],null,null),(n()(),i.qb(7,0,[[1,0],["map",1]],0,0,"div",[["id","map"]],null,null,null,null,null)),(n()(),i.qb(8,0,null,null,11,"ion-footer",[["class","footer-bus-route-details"]],null,null,null,_.gb,_.o)),i.pb(9,49152,null,0,l.B,[i.h,i.k,i.z],null,null),(n()(),i.qb(10,0,null,0,9,"ion-grid",[["no-margin",""],["no-paading",""]],null,null,null,_.hb,_.p)),i.pb(11,49152,null,0,l.C,[i.h,i.k,i.z],null,null),(n()(),i.qb(12,0,null,0,3,"ion-row",[["no-margin",""],["text-center",""]],null,null,null,_.zb,_.H)),i.pb(13,49152,null,0,l.kb,[i.h,i.k,i.z],null,null),(n()(),i.hb(16777216,null,0,1,null,O)),i.pb(15,16384,null,0,z.j,[i.P,i.L],{ngIf:[0,"ngIf"]},null),(n()(),i.qb(16,0,null,0,3,"ion-row",[["no-margin",""],["text-center",""]],null,null,null,_.zb,_.H)),i.pb(17,49152,null,0,l.kb,[i.h,i.k,i.z],null,null),(n()(),i.hb(16777216,null,0,1,null,x)),i.pb(19,16384,null,0,z.j,[i.P,i.L],{ngIf:[0,"ngIf"]},null)],function(n,t){var o=t.component;n(t,2,0),n(t,4,0,o.progress_bar),n(t,15,0,!o.isTracking),n(t,19,0,o.isTracking)},null)}function R(n){return i.Hb(0,[(n()(),i.qb(0,0,null,null,1,"app-location-tracking",[],null,null,null,A,C)),i.pb(1,114688,null,0,d,[l.Kb,l.Nb,r.a,T.b,a.a,s.a,D.a,E.a,c.a,w.a,u.a],null,null)],function(n,t){n(t,1,0)},null)}var F=i.mb("app-location-tracking",d,R,{},{},[]),G=o("gIcY"),H=o("qxEu");o.d(t,"LocationTrackingPageModuleNgFactory",function(){return S});var S=i.nb(g,[],function(n){return i.xb([i.yb(512,i.j,i.cb,[[8,[h.a,F]],[3,i.j],i.x]),i.yb(4608,z.l,z.k,[i.u,[2,z.t]]),i.yb(4608,G.t,G.t,[]),i.yb(4608,l.c,l.c,[i.z,i.g]),i.yb(4608,l.Jb,l.Jb,[l.c,i.j,i.q]),i.yb(4608,l.Ob,l.Ob,[l.c,i.j,i.q]),i.yb(1073742336,z.b,z.b,[]),i.yb(1073742336,G.r,G.r,[]),i.yb(1073742336,G.e,G.e,[]),i.yb(1073742336,l.Fb,l.Fb,[]),i.yb(1073742336,w.q,w.q,[[2,w.w],[2,w.m]]),i.yb(1073742336,v.f,v.f,[]),i.yb(1073742336,H.a,H.a,[]),i.yb(1073742336,g,g,[]),i.yb(1024,w.k,function(){return[[{path:"",component:d}]]},[])])})}}]);