(window.webpackJsonp=window.webpackJsonp||[]).push([[26],{bNZI:function(t,n,o){"use strict";o.r(n);var e=o("CcnG"),i=o("mrSG"),r=o("gTw3"),a=o("ZZ/e"),l=o("23JA"),s=o("UNbJ"),c=o("k82s"),u=o("Ht5U"),d=o("67Y/"),p=function(){function t(t,n,o,e,i,r,a,l,s,c,u){var d=this;this.navCtrl=t,this.plt=n,this.geolocation=o,this.storage=e,this.nativeGeocoder=i,this.backgroundGeolocation=r,this.afAuth=a,this.afs=l,this.localNotifications=s,this.route=c,this.officePoolCarService=u,this.progress_bar=!1,this.directionsService=new google.maps.DirectionsService,this.directionsDisplay=new google.maps.DirectionsRenderer({suppressMarkers:!0}),this.distanceService=new google.maps.DistanceMatrixService,this.DirectionsWaypoint=[],this.arr=[],this.user=null,this.currentMapTrack=null,this.markers=[],this.isTracking=!1,this.trackedRoute=[],this.previousTracks=[],this.loc=[],this.geoencoderOptions={useLocale:!0,maxResults:5},this.stoppage_list=[],this.start_location="",this.end_location="",this.car_type="",this.route_id="",this.driver_id="",console.log("constructor"),this.car_id=this.route.snapshot.params.car_id,this.driver_id=this.route.snapshot.params.driver_id,this.storage.get("car_details").then(function(t){t&&t.forEach(function(t){if(t.car_id==d.car_id){console.log(t),d.route_id=t.route_id,d.stoppage_list=t.stoppage_list,d.start_location=t.start_location,d.end_location=t.end_location,d.car_type=t.car_type,d.loadMap({lat:parseFloat(t.start_lat),lng:parseFloat(t.start_long)},{lat:parseFloat(t.end_lat),lng:parseFloat(t.end_long)}),t.stoppage_list_1.forEach(function(t){var n;n={location:{lat:parseFloat(t.location.lat),lng:parseFloat(t.location.lng)},stopover:t.stopover},d.DirectionsWaypoint.push(n)}),d.ride_startTime=parseFloat(t.start_end_time.start_time),d.ride_endTime=parseFloat(t.start_end_time.end_time);var n=new Date;console.log("Current Date ",100*n.getHours()+n.getMinutes()),console.log("ride time1",d.ride_startTime)}})}),this.storage.get("USER_INFO").then(function(t){t&&d.anonLogin(t.user_account_no+"-"+t.name+"-"+new Date)})}return t.prototype.ngOnInit=function(){var t=this;console.log("ngOnInit"),this.backgroundGeolocation.configure({desiredAccuracy:10,stationaryRadius:20,interval:2e3,distanceFilter:30,debug:!0,stopOnTerminate:!1}).then(function(){t.backgroundGeolocation.on(s.b.location).subscribe(function(n){console.log(n),t.driver_current_lat=n.latitude,t.driver_current_lng=n.longitude,t.update_driver_cordinated_to_firebase(),t.backgroundGeolocation.finish()})})},t.prototype.ionViewDidEnter=function(){console.log("ionViewDidEnter"),this.plt.ready().then(function(){})},t.prototype.ionViewWillEnter=function(){console.log("ionViewWillEnter")},t.prototype.loadMap=function(t,n){var o=this;this.map=new google.maps.Map(this.mapElement.nativeElement,{center:{lat:-34.9011,lng:-56.1645},zoom:30,mapTypeId:google.maps.MapTypeId.ROADMAP,disableDefaultUI:!0}),this.geolocation.getCurrentPosition().then(function(t){var n={lat:t.coords.latitude,lng:t.coords.longitude};o.driver_marker=new google.maps.Marker({position:n,map:o.map,icon:"http://tobuekalabya.com/carservice_manage/icon/car_top.png",title:"you are here!"}),o.map.setCenter(n),o.map.setZoom(30)}).catch(function(t){console.log("Error getting location",t)}),this.directionsDisplay.setMap(this.map),console.log("start_loc",this.start_location),this.location_source=t,this.location_destination=n,this.calculateAndDisplayRoute()},t.prototype.calculateAndDisplayRoute=function(){var t=this,n=this;n.directionsService.route({origin:this.location_source,destination:this.location_destination,travelMode:"DRIVING",waypoints:this.DirectionsWaypoint},function(o,e){"OK"===e?(n.directionsDisplay.setDirections(o),t.stoppage_list.forEach(function(n){var o={lat:parseFloat(n.lat),lng:parseFloat(n.lng)};new google.maps.InfoWindow({content:String(n.location_name)}),new google.maps.Marker({position:o,map:t.map,icon:n.icon,title:"you are here!"})})):window.alert("Directions request failed due to "+e)})},t.prototype.anonLogin=function(t){var n=this;this.afAuth.auth.signInAnonymously().then(function(o){n.locationsCollection=n.afs.collection("locations/"+t+"/track",function(t){return t.orderBy("timestamp")}),n.locations=n.locationsCollection.snapshotChanges().pipe(Object(d.a)(function(t){return t.map(function(t){var n=t.payload.doc.data();return i.__assign({id:t.payload.doc.id},n)})})),console.log("this.locations",n.locations),n.locations.subscribe(function(t){console.log("new location: ",t),n.loc=t})})},t.prototype.startTracking=function(){var t,n=this,o=this;this.geolocation.getCurrentPosition().then(function(e){t=e.coords.longitude;var i=parseFloat(e.coords.latitude),r=parseFloat(t);n.distanceService.getDistanceMatrix({origins:[new google.maps.LatLng(i,r)],destinations:[n.location_source],travelMode:"DRIVING",unitSystem:google.maps.UnitSystem.METRIC,avoidHighways:!1,avoidTolls:!1},function(t,n){if("OK"!==n)alert("Error was: "+n);else if(this.driver_distance_from_starting_point=parseFloat(t.rows[0].elements[0].distance.text),console.log("originList",this.driver_distance_from_starting_point),console.log("distance dirve",parseFloat(this.driver_distance_from_starting_point)),this.driver_distance_from_starting_point<=2){var e=new Date;if(console.log("Current Date ",100*e.getHours()+e.getMinutes()),console.log("ride timeqwe",o.ride_startTime-150),o.ride_startTime-150<=100*e.getHours()+e.getMinutes()){console.log("ride time",parseFloat(o.ride_startTime)-150),o.isTracking=!0,o.geolocation.getCurrentPosition().then(function(t){var n={};n.lat=t.coords.latitude,n.long=t.coords.longitude,n.name="";var e=o.car_type+"-"+o.car_id;o.afs.collection("locations").doc(e).set(n)}).catch(function(t){console.log("Error getting location",t)}),o.backgroundGeolocation.start();var i=1;o.trackedRoute=[],o.watch=o.geolocation.watchPosition({frequency:3e3,enableHighAccuracy:!0}).subscribe(function(t){if(console.log("new position: ",t),t){o.trackedRoute.push({lat:t.coords.latitude,lng:t.coords.longitude,address:o.geoAddress,point_number:i}),i++,o.driver_current_lat=t.coords.latitude,o.driver_current_lng=t.coords.longitude;var n=new google.maps.LatLng(o.driver_current_lat,o.driver_current_lng);console.log(n),o.driver_marker.setPosition(n),o.map.panTo(n),o.update_driver_cordinated_to_firebase()}}),o.sendNotificationToPassengers()}else alert("Please Start the ride within time!")}else alert("The Driver must Start the ride from the Starting point of the route!")})}).catch(function(t){console.log("Error getting location",t)})},t.prototype.update_driver_cordinated_to_firebase=function(){var t={};t.lat=this.driver_current_lat,t.long=this.driver_current_lng,t.name="test1.03.2020";var n=this.car_type+"-"+this.car_id;this.afs.collection("locations").doc(n).update(t)},t.prototype.stopTracking=function(){if(google.maps.LatLng(this.driver_current_lat,this.driver_current_lng)==this.location_source){this.isTracking=!1,this.backgroundGeolocation.stop(),this.watch.unsubscribe();var t=this.car_type+"-"+this.car_id;this.afs.collection("locations").doc(t).delete(),this.endJourney()}else alert("The Driver must End the ride from the Ending point of the route!")},t.prototype.sendNotificationToPassengers=function(){var t=this;this.progress_bar=!0;var n={type:"drive_start",route_id:this.route_id,route_timing_id:0,car_id:this.car_id,driver_id:this.driver_id};console.log("request_data",n),this.officePoolCarService.todayRidesService(n).subscribe(function(n){t.storage.set("drive_history_id",n.result.drive_history_id),t.progress_bar=!1},function(n){t.progress_bar=!1})},t.prototype.endJourney=function(){var t=this;this.progress_bar=!0,this.storage.get("drive_history_id").then(function(n){n&&t.officePoolCarService.todayRidesService({type:"drive_end",drive_history_id:n}).subscribe(function(n){t.progress_bar=!1},function(n){t.progress_bar=!1})})},t}(),g=function(){return function(){}}(),h=o("pMnS"),_=o("bAmN"),b=o("oBZk"),f=o("fNgX"),m=o("Hf/j"),v=o("ZYjt"),y=o("jWFl"),k=o("OOyK"),w=o("ZYCi"),T=o("iw74"),M=o("jKJn"),D=o("xoVG"),P=o("ZgVV"),I=o("cGva"),q=o("Ip0R"),C=o("ZBkt"),S=o("fvl4"),E=e.ob({encapsulation:0,styles:[["#map[_ngcontent-%COMP%]{width:100%;height:550px}#markerLayer[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{animation:.5s infinite alternate pulse;-webkit-animation:.5s infinite alternate pulse;transform-origin:center;-webkit-transform-origin:center}.footer-bus-route-details[_ngcontent-%COMP%]{background:#0a5999;color:#fff;text-align:center;padding:0 10px}ion-toolbar[_ngcontent-%COMP%]{--background:transparent;--color:white}"],_.a],data:{}});function F(t){return e.Hb(0,[(t()(),e.qb(0,0,null,null,1,"ion-progress-bar",[["class","progress_bar"],["type","indeterminate"]],null,null,null,b.wb,b.E)),e.pb(1,49152,null,0,a.ab,[e.h,e.k,e.z],{type:[0,"type"]},null)],function(t,n){t(n,1,0,"indeterminate")},null)}function z(t){return e.Hb(0,[(t()(),e.qb(0,0,null,null,5,"ion-col",[["no-margin",""],["style","font-size: 20px;"]],null,[[null,"click"]],function(t,n,o){var e=!0;return"click"===n&&(e=!1!==t.component.startTracking()&&e),e},b.ab,b.i)),e.pb(1,49152,null,0,a.v,[e.h,e.k,e.z],null,null),(t()(),e.qb(2,0,null,0,2,"fa-icon",[["class","rstar-icon ng-fa-icon"],["size","1x"]],[[8,"innerHTML",1]],null,null,f.b,f.a)),e.pb(3,573440,null,0,m.a,[v.c,m.b],{iconProp:[0,"iconProp"],size:[1,"size"]},null),e.Bb(4,2),(t()(),e.Gb(-1,0,[" START "]))],function(t,n){var o=t(n,4,0,"fas","play-circle");t(n,3,0,o,"1x")},function(t,n){t(n,2,0,e.Ab(n,3).renderedIconHTML)})}function x(t){return e.Hb(0,[(t()(),e.qb(0,0,null,null,5,"ion-col",[["no-margin",""],["style","font-size: 20px;"]],null,[[null,"click"]],function(t,n,o){var e=!0;return"click"===n&&(e=!1!==t.component.stopTracking()&&e),e},b.ab,b.i)),e.pb(1,49152,null,0,a.v,[e.h,e.k,e.z],null,null),(t()(),e.qb(2,0,null,0,2,"fa-icon",[["class","rstar-icon ng-fa-icon"],["size","1x"]],[[8,"innerHTML",1]],null,null,f.b,f.a)),e.pb(3,573440,null,0,m.a,[v.c,m.b],{iconProp:[0,"iconProp"],size:[1,"size"]},null),e.Bb(4,2),(t()(),e.Gb(-1,0,[" STOP "]))],function(t,n){var o=t(n,4,0,"fas","stop-circle");t(n,3,0,o,"1x")},function(t,n){t(n,2,0,e.Ab(n,3).renderedIconHTML)})}function L(t){return e.Hb(0,[e.Eb(402653184,1,{mapElement:0}),(t()(),e.qb(1,0,null,null,1,"app-header",[],null,null,null,y.b,y.a)),e.pb(2,114688,null,0,k.a,[w.m,a.f,T.b,M.a,D.a,u.a,P.a,I.a],null,null),(t()(),e.hb(16777216,null,null,1,null,F)),e.pb(4,16384,null,0,q.j,[e.P,e.L],{ngIf:[0,"ngIf"]},null),(t()(),e.qb(5,0,null,null,2,"ion-content",[],null,null,null,b.bb,b.j)),e.pb(6,49152,null,0,a.w,[e.h,e.k,e.z],null,null),(t()(),e.qb(7,0,[[1,0],["map",1]],0,0,"div",[["id","map"]],null,null,null,null,null)),(t()(),e.qb(8,0,null,null,11,"ion-footer",[["class","footer-bus-route-details"]],null,null,null,b.gb,b.o)),e.pb(9,49152,null,0,a.B,[e.h,e.k,e.z],null,null),(t()(),e.qb(10,0,null,0,9,"ion-grid",[["no-margin",""],["no-paading",""]],null,null,null,b.hb,b.p)),e.pb(11,49152,null,0,a.C,[e.h,e.k,e.z],null,null),(t()(),e.qb(12,0,null,0,3,"ion-row",[["no-margin",""],["text-center",""]],null,null,null,b.zb,b.H)),e.pb(13,49152,null,0,a.kb,[e.h,e.k,e.z],null,null),(t()(),e.hb(16777216,null,0,1,null,z)),e.pb(15,16384,null,0,q.j,[e.P,e.L],{ngIf:[0,"ngIf"]},null),(t()(),e.qb(16,0,null,0,3,"ion-row",[["no-margin",""],["text-center",""]],null,null,null,b.zb,b.H)),e.pb(17,49152,null,0,a.kb,[e.h,e.k,e.z],null,null),(t()(),e.hb(16777216,null,0,1,null,x)),e.pb(19,16384,null,0,q.j,[e.P,e.L],{ngIf:[0,"ngIf"]},null)],function(t,n){var o=n.component;t(n,2,0),t(n,4,0,o.progress_bar),t(n,15,0,!o.isTracking),t(n,19,0,o.isTracking)},null)}function O(t){return e.Hb(0,[(t()(),e.qb(0,0,null,null,1,"app-location-tracking",[],null,null,null,L,E)),e.pb(1,114688,null,0,p,[a.Kb,a.Nb,r.a,T.b,l.a,s.a,C.a,S.a,c.a,w.a,u.a],null,null)],function(t,n){t(n,1,0)},null)}var H=e.mb("app-location-tracking",p,O,{},{},[]),R=o("gIcY"),A=o("qxEu");o.d(n,"LocationTrackingPageModuleNgFactory",function(){return G});var G=e.nb(g,[],function(t){return e.xb([e.yb(512,e.j,e.cb,[[8,[h.a,H]],[3,e.j],e.x]),e.yb(4608,q.l,q.k,[e.u,[2,q.t]]),e.yb(4608,R.t,R.t,[]),e.yb(4608,a.c,a.c,[e.z,e.g]),e.yb(4608,a.Jb,a.Jb,[a.c,e.j,e.q]),e.yb(4608,a.Ob,a.Ob,[a.c,e.j,e.q]),e.yb(1073742336,q.b,q.b,[]),e.yb(1073742336,R.r,R.r,[]),e.yb(1073742336,R.e,R.e,[]),e.yb(1073742336,a.Fb,a.Fb,[]),e.yb(1073742336,w.q,w.q,[[2,w.w],[2,w.m]]),e.yb(1073742336,m.f,m.f,[]),e.yb(1073742336,A.a,A.a,[]),e.yb(1073742336,g,g,[]),e.yb(1024,w.k,function(){return[[{path:"",component:p}]]},[])])})}}]);