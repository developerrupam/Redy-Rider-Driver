(window.webpackJsonp=window.webpackJsonp||[]).push([[26],{bNZI:function(n,t,o){"use strict";o.r(t);var e=o("CcnG"),i=o("mrSG"),l=o("gTw3"),r=o("ZZ/e"),a=o("23JA"),s=o("UNbJ"),c=o("k82s"),u=o("Ht5U"),p=o("rk9M"),d=o("zA0m"),g=o("ZgVV"),b=o("y8gV"),h=o("8jtY"),_=o("S0jo"),f=o("67Y/"),m=function(){function n(n,t,o,e,i,l,r,a,s,c,u,p,d,g,b,h,_){var f=this;this.navCtrl=n,this.plt=t,this.geolocation=o,this.storage=e,this.nativeGeocoder=i,this.backgroundGeolocation=l,this.afAuth=r,this.afs=a,this.localNotifications=s,this.route=c,this.officePoolCarService=u,this.insomnia=p,this.barcodeScanner=d,this.toasterService=g,this.alertController=b,this.authenticationService=h,this.modalService=_,this.progress_bar=!1,this.directionsService=new google.maps.DirectionsService,this.directionsDisplay=new google.maps.DirectionsRenderer({suppressMarkers:!0}),this.distanceService=new google.maps.DistanceMatrixService,this.DirectionsWaypoint=[],this.back_button_visible=!0,this.arr=[],this.user=null,this.currentMapTrack=null,this.markers=[],this.isTracking=!1,this.trackedRoute=[],this.previousTracks=[],this.loc=[],this.geoencoderOptions={useLocale:!0,maxResults:5},this.stoppage_list=[],this.start_location="",this.end_location="",this.car_type="",this.route_id="",this.driver_id="",console.log("constructor"),this.car_id=this.route.snapshot.params.car_id,this.driver_id=this.route.snapshot.params.driver_id,this.storage.get("car_details").then(function(n){n&&n.forEach(function(n){n.car_id==f.car_id&&(console.log(n),f.route_id=n.route_id,f.stoppage_list=n.stoppage_list,f.start_location=n.start_location,f.end_location=n.end_location,f.car_type=n.car_type,f.route_end_point=n.end_point_id,f.route_start_point=n.start_point_id,f.loadMap({lat:parseFloat(n.start_lat),lng:parseFloat(n.start_long)},{lat:parseFloat(n.end_lat),lng:parseFloat(n.end_long)}),n.stoppage_list_1.forEach(function(n){var t;t={location:{lat:parseFloat(n.location.lat),lng:parseFloat(n.location.lng)},stopover:n.stopover},f.DirectionsWaypoint.push(t)}),f.ride_startTime=parseFloat(n.start_end_time.start_time),f.ride_endTime=parseFloat(n.start_end_time.end_time))})}),this.storage.get("USER_INFO").then(function(n){n&&f.anonLogin(n.user_account_no+"-"+n.name+"-"+new Date)})}return n.prototype.ngOnInit=function(){var n=this;console.log("ngOnInit"),this.backgroundGeolocation.configure({desiredAccuracy:10,stationaryRadius:20,interval:2e3,distanceFilter:30,debug:!0,stopOnTerminate:!1}).then(function(){n.backgroundGeolocation.on(s.b.location).subscribe(function(t){console.log(t),n.driver_current_lat=t.latitude,n.driver_current_lng=t.longitude,n.update_driver_cordinated_to_firebase(),n.backgroundGeolocation.finish()})})},n.prototype.ionViewDidEnter=function(){console.log("ionViewDidEnter"),this.plt.ready().then(function(){})},n.prototype.ionViewWillEnter=function(){console.log("ionViewWillEnter")},n.prototype.loadMap=function(n,t){var o=this;this.map=new google.maps.Map(this.mapElement.nativeElement,{center:{lat:-34.9011,lng:-56.1645},zoom:30,mapTypeId:google.maps.MapTypeId.ROADMAP,disableDefaultUI:!0}),this.geolocation.getCurrentPosition().then(function(n){var t={lat:n.coords.latitude,lng:n.coords.longitude};o.driver_marker=new google.maps.Marker({position:t,map:o.map,icon:"http://tobuekalabya.com/carservice_manage/icon/icon_map_baloon.png",title:"you are here!"}),o.map.setCenter(t),o.map.setZoom(30)}).catch(function(n){console.log("Error getting location",n)}),this.directionsDisplay.setMap(this.map),console.log("start_loc",this.start_location),this.location_source=n,this.location_destination=t,this.calculateAndDisplayRoute()},n.prototype.calculateAndDisplayRoute=function(){var n=this,t=this;t.directionsService.route({origin:this.location_source,destination:this.location_destination,travelMode:"DRIVING",waypoints:this.DirectionsWaypoint},function(o,e){"OK"===e?(t.directionsDisplay.setDirections(o),n.stoppage_list.forEach(function(t){var o={lat:parseFloat(t.lat),lng:parseFloat(t.lng)};new google.maps.InfoWindow({content:String(t.location_name)}),new google.maps.Marker({position:o,map:n.map,icon:t.icon,title:"you are here!"})})):window.alert("Directions request failed due to "+e)})},n.prototype.anonLogin=function(n){var t=this;this.afAuth.auth.signInAnonymously().then(function(o){t.locationsCollection=t.afs.collection("locations/"+n+"/track",function(n){return n.orderBy("timestamp")}),t.locations=t.locationsCollection.snapshotChanges().pipe(Object(f.a)(function(n){return n.map(function(n){var t=n.payload.doc.data();return i.__assign({id:n.payload.doc.id},t)})})),console.log("this.locations",t.locations),t.locations.subscribe(function(n){console.log("new location: ",n),t.loc=n})})},n.prototype.startTracking=function(){var n=this,t=this.car_type+"-"+this.car_id;this.afs.collection("locations").snapshotChanges().subscribe(function(o){o.map(function(o){o.payload.doc.id==t&&(n.already_exist_firebase=!0)})}),1==this.already_exist_firebase?(console.log("sdfffffdsfdfsdfd"),this.tracking_location()):this.create_tracking_inFirebase()},n.prototype.create_tracking_inFirebase=function(){var n,t=this,o=this;this.geolocation.getCurrentPosition().then(function(e){n=e.coords.longitude;var i=parseFloat(e.coords.latitude),l=parseFloat(n);t.distanceService.getDistanceMatrix({origins:[new google.maps.LatLng(i,l)],destinations:[t.location_source],travelMode:"DRIVING",unitSystem:google.maps.UnitSystem.METRIC,avoidHighways:!1,avoidTolls:!1},function(n,t){if("OK"!==t)alert("Error was: "+t);else if(o.driver_distance_from_starting_point=parseFloat(n.rows[0].elements[0].distance.text),o.driver_distance_from_starting_point<=2){this.back_button_visible=!1;var e=new Date;if(o.ride_startTime-15<=100*e.getHours()+e.getMinutes()){console.log("ride time",parseFloat(o.ride_startTime)-15);var r={};r.lat=i,r.long=l,r.name="";var a=o.car_type+"-"+o.car_id;o.afs.collection("locations").doc(a).set(r),o.tracking_location()}else alert("Please Start the ride within time!")}else alert("The Driver must Start the ride from the Starting point of the route!")})}).catch(function(n){console.log("Error getting location",n)})},n.prototype.tracking_location=function(){var n=this;this.isTracking=!0,this.back_button_visible=!1,this.insomnia.keepAwake().then(function(){return console.log("success")},function(){return console.log("error")}),this.backgroundGeolocation.start();var t=1;this.trackedRoute=[],this.watch=this.geolocation.watchPosition({frequency:3e3,enableHighAccuracy:!0}).subscribe(function(o){if(console.log("new position: ",o),o){n.trackedRoute.push({lat:o.coords.latitude,lng:o.coords.longitude,address:n.geoAddress,point_number:t}),t++,n.driver_current_lat=o.coords.latitude,n.driver_current_lng=o.coords.longitude;var e=new google.maps.LatLng(n.driver_current_lat,n.driver_current_lng);console.log(e),n.driver_marker.setPosition(e),n.map.panTo(e),n.update_driver_cordinated_to_firebase()}}),this.sendNotificationToPassengers()},n.prototype.update_driver_cordinated_to_firebase=function(){var n={};n.lat=this.driver_current_lat,n.long=this.driver_current_lng,n.name="test1.03.2020";var t=this.car_type+"-"+this.car_id;this.afs.collection("locations").doc(t).update(n)},n.prototype.stopTracking=function(){var n,t=this,o=this;this.geolocation.getCurrentPosition().then(function(e){n=e.coords.longitude;var i=parseFloat(e.coords.latitude),l=parseFloat(n);t.distanceService.getDistanceMatrix({origins:[new google.maps.LatLng(i,l)],destinations:[t.location_destination],travelMode:"DRIVING",unitSystem:google.maps.UnitSystem.METRIC,avoidHighways:!1,avoidTolls:!1},function(n,t){if("OK"!==t)alert("Error was: "+t);else if(o.driver_distance_from_ending_point=parseFloat(n.rows[0].elements[0].distance.text),console.log("destinationList",o.driver_distance_from_ending_point),o.driver_distance_from_starting_point<=.5){o.isTracking=!1,o.backgroundGeolocation.stop(),o.watch.unsubscribe(),this.insomnia.allowSleepAgain().then(function(){return console.log("success")},function(){return console.log("error")});var e=this.car_type+"-"+this.car_id;this.afs.collection("locations").doc(e).delete(),this.endJourney(),this.authenticationService.logout(),navigator.app.exitApp()}else alert("The Driver must End the ride from the Ending point of the route!")})}).catch(function(n){console.log("Error getting location",n)})},n.prototype.sendNotificationToPassengers=function(){var n=this;this.progress_bar=!0;var t={type:"drive_start",route_id:this.route_id,route_timing_id:0,car_id:this.car_id,driver_id:this.driver_id};console.log("request_data",t),this.officePoolCarService.todayRidesService(t).subscribe(function(t){n.storage.set("drive_history_id",t.result.drive_history_id),n.progress_bar=!1},function(t){n.progress_bar=!1})},n.prototype.endJourney=function(){var n=this;this.progress_bar=!0,this.storage.get("drive_history_id").then(function(t){t&&n.officePoolCarService.todayRidesService({type:"drive_end",drive_history_id:t}).subscribe(function(t){n.progress_bar=!1},function(t){n.progress_bar=!1})})},n.prototype.scanQrCode=function(){var n=this;this.barcodeScanner.scan().then(function(t){n.progress_bar=!0,n.officePoolCarService.todayRidesService({type:"qr_code_val",car_id:n.car_id,qr_code:t.text}).subscribe(function(t){n.toasterService.showToast(t.result,2e3),n.progress_bar=!1},function(t){n.progress_bar=!1,n.toasterService.showToast(t.error.msg,2e3)})}).catch(function(n){console.log("Error",n)})},n.prototype.stopConfirm=function(){return i.__awaiter(this,void 0,void 0,function(){var n=this;return i.__generator(this,function(t){switch(t.label){case 0:return[4,this.alertController.create({message:"Are you sure you want end this journey!!",buttons:[{text:"No",role:"cancel",cssClass:"alert-cancel-button",handler:function(t){n.alertResponseForLogout(!1)}},{text:"Yes",cssClass:"alert-ok-button",handler:function(){n.alertResponseForLogout(!0)}}]})];case 1:return[4,t.sent().present()];case 2:return t.sent(),[2]}})})},n.prototype.alertResponseForLogout=function(n){n&&this.stopTracking()},n.prototype.viewRoute=function(){this.modalService.openModal(h.a,{from_which_page:"location-tracking-page",stoppage_list:this.stoppage_list},"stoppage_modal_css")},n}(),v=function(){return function(){}}(),y=o("pMnS"),k=o("bAmN"),w=o("oBZk"),T=o("fNgX"),q=o("Hf/j"),S=o("ZYjt"),x=o("Ip0R"),z=o("iw74"),M=o("ZBkt"),C=o("fvl4"),I=o("ZYCi"),P=e.ob({encapsulation:0,styles:[["#map[_ngcontent-%COMP%]{width:100%;height:550px}#markerLayer[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{animation:.5s infinite alternate pulse;-webkit-animation:.5s infinite alternate pulse;transform-origin:center;-webkit-transform-origin:center}.footer-bus-route-details[_ngcontent-%COMP%]{background:#0a5999;color:#fff;text-align:center;padding:0 10px}ion-header[_ngcontent-%COMP%]{--ion-background-color:linear-gradient(45deg, #0A5999 0%, #02A1EB 100%);--ion-text-color:#fff}.qr_card[_ngcontent-%COMP%]{text-align:center;background:0 0;box-shadow:none;color:#fff;margin-right:20px}"],k.a],data:{}});function D(n){return e.Hb(0,[(n()(),e.qb(0,0,null,null,4,"ion-buttons",[["class","border_button"],["slot","start"]],null,null,null,w.W,w.e)),e.pb(1,49152,null,0,r.n,[e.h,e.k,e.z],null,null),(n()(),e.qb(2,0,null,0,2,"ion-back-button",[["defaultHref","home"]],null,[[null,"click"]],function(n,t,o){var i=!0;return"click"===t&&(i=!1!==e.Ab(n,4).onClick(o)&&i),i},w.T,w.b)),e.pb(3,49152,null,0,r.i,[e.h,e.k,e.z],{defaultHref:[0,"defaultHref"]},null),e.pb(4,16384,null,0,r.j,[[2,r.jb],r.Kb],{defaultHref:[0,"defaultHref"]},null)],function(n,t){n(t,3,0,"home"),n(t,4,0,"home")},null)}function F(n){return e.Hb(0,[(n()(),e.qb(0,0,null,null,1,"ion-progress-bar",[["class","progress_bar"],["type","indeterminate"]],null,null,null,w.wb,w.E)),e.pb(1,49152,null,0,r.ab,[e.h,e.k,e.z],{type:[0,"type"]},null)],function(n,t){n(t,1,0,"indeterminate")},null)}function E(n){return e.Hb(0,[(n()(),e.qb(0,0,null,null,5,"ion-col",[["no-margin",""],["style","font-size: 20px;"]],null,[[null,"click"]],function(n,t,o){var e=!0;return"click"===t&&(e=!1!==n.component.startTracking()&&e),e},w.ab,w.i)),e.pb(1,49152,null,0,r.v,[e.h,e.k,e.z],null,null),(n()(),e.qb(2,0,null,0,2,"fa-icon",[["class","rstar-icon ng-fa-icon"],["size","1x"]],[[8,"innerHTML",1]],null,null,T.b,T.a)),e.pb(3,573440,null,0,q.a,[S.c,q.b],{iconProp:[0,"iconProp"],size:[1,"size"]},null),e.Bb(4,2),(n()(),e.Gb(-1,0,[" START "]))],function(n,t){var o=n(t,4,0,"fas","play-circle");n(t,3,0,o,"1x")},function(n,t){n(t,2,0,e.Ab(t,3).renderedIconHTML)})}function R(n){return e.Hb(0,[(n()(),e.qb(0,0,null,null,5,"ion-col",[["no-margin",""],["style","font-size: 20px;"]],null,[[null,"click"]],function(n,t,o){var e=!0;return"click"===t&&(e=!1!==n.component.stopConfirm()&&e),e},w.ab,w.i)),e.pb(1,49152,null,0,r.v,[e.h,e.k,e.z],null,null),(n()(),e.qb(2,0,null,0,2,"fa-icon",[["class","rstar-icon ng-fa-icon"],["size","1x"]],[[8,"innerHTML",1]],null,null,T.b,T.a)),e.pb(3,573440,null,0,q.a,[S.c,q.b],{iconProp:[0,"iconProp"],size:[1,"size"]},null),e.Bb(4,2),(n()(),e.Gb(-1,0,[" STOP "]))],function(n,t){var o=n(t,4,0,"fas","stop-circle");n(t,3,0,o,"1x")},function(n,t){n(t,2,0,e.Ab(t,3).renderedIconHTML)})}function H(n){return e.Hb(0,[e.Eb(402653184,1,{mapElement:0}),(n()(),e.qb(1,0,null,null,21,"ion-header",[],null,null,null,w.ib,w.q)),e.pb(2,49152,null,0,r.D,[e.h,e.k,e.z],null,null),(n()(),e.qb(3,0,null,0,19,"ion-toolbar",[["class","header-menu"]],null,null,null,w.Ib,w.Q)),e.pb(4,49152,null,0,r.Db,[e.h,e.k,e.z],null,null),(n()(),e.hb(16777216,null,0,1,null,D)),e.pb(6,16384,null,0,x.j,[e.P,e.L],{ngIf:[0,"ngIf"]},null),(n()(),e.qb(7,0,null,0,2,"ion-title",[["slot","start"],["style","padding: 0px;"]],null,null,null,w.Gb,w.O)),e.pb(8,49152,null,0,r.Bb,[e.h,e.k,e.z],null,null),(n()(),e.Gb(-1,0,[" Tracking "])),(n()(),e.qb(10,0,null,0,6,"ion-card",[["class","qr_card"],["slot","end"],["type","button"]],null,[[null,"click"]],function(n,t,o){var e=!0;return"click"===t&&(e=!1!==n.component.viewRoute()&&e),e},w.Y,w.f)),e.pb(11,49152,null,0,r.o,[e.h,e.k,e.z],{type:[0,"type"]},null),(n()(),e.qb(12,0,null,0,2,"fa-icon",[["class","rstar-icon ng-fa-icon"],["size","1x"],["style","font-size: 21px;"]],[[8,"innerHTML",1]],null,null,T.b,T.a)),e.pb(13,573440,null,0,q.a,[S.c,q.b],{iconProp:[0,"iconProp"],size:[1,"size"]},null),e.Bb(14,2),(n()(),e.qb(15,0,null,0,1,"p",[["class","no_margin_p"],["style","font-size:13px;"]],null,null,null,null,null)),(n()(),e.Gb(-1,null,["Stoppage"])),(n()(),e.qb(17,0,null,0,5,"ion-card",[["class","qr_card"],["slot","end"],["type","button"]],null,[[null,"click"]],function(n,t,o){var e=!0;return"click"===t&&(e=!1!==n.component.scanQrCode()&&e),e},w.Y,w.f)),e.pb(18,49152,null,0,r.o,[e.h,e.k,e.z],{type:[0,"type"]},null),(n()(),e.qb(19,0,null,0,1,"ion-icon",[["ios","ios-qr-scanner"],["md","md-qr-scanner"],["style","font-size: 21px;"]],null,null,null,w.jb,w.r)),e.pb(20,49152,null,0,r.E,[e.h,e.k,e.z],{ios:[0,"ios"],md:[1,"md"]},null),(n()(),e.qb(21,0,null,0,1,"p",[["class","no_margin_p"],["style","font-size:13px;"]],null,null,null,null,null)),(n()(),e.Gb(-1,null,["Scan QR"])),(n()(),e.hb(16777216,null,null,1,null,F)),e.pb(24,16384,null,0,x.j,[e.P,e.L],{ngIf:[0,"ngIf"]},null),(n()(),e.qb(25,0,null,null,2,"ion-content",[],null,null,null,w.bb,w.j)),e.pb(26,49152,null,0,r.w,[e.h,e.k,e.z],null,null),(n()(),e.qb(27,0,[[1,0],["map",1]],0,0,"div",[["id","map"]],null,null,null,null,null)),(n()(),e.qb(28,0,null,null,11,"ion-footer",[["class","footer-bus-route-details"]],null,null,null,w.gb,w.o)),e.pb(29,49152,null,0,r.B,[e.h,e.k,e.z],null,null),(n()(),e.qb(30,0,null,0,9,"ion-grid",[["no-margin",""],["no-paading",""]],null,null,null,w.hb,w.p)),e.pb(31,49152,null,0,r.C,[e.h,e.k,e.z],null,null),(n()(),e.qb(32,0,null,0,3,"ion-row",[["no-margin",""],["text-center",""]],null,null,null,w.zb,w.H)),e.pb(33,49152,null,0,r.kb,[e.h,e.k,e.z],null,null),(n()(),e.hb(16777216,null,0,1,null,E)),e.pb(35,16384,null,0,x.j,[e.P,e.L],{ngIf:[0,"ngIf"]},null),(n()(),e.qb(36,0,null,0,3,"ion-row",[["no-margin",""],["text-center",""]],null,null,null,w.zb,w.H)),e.pb(37,49152,null,0,r.kb,[e.h,e.k,e.z],null,null),(n()(),e.hb(16777216,null,0,1,null,R)),e.pb(39,16384,null,0,x.j,[e.P,e.L],{ngIf:[0,"ngIf"]},null)],function(n,t){var o=t.component;n(t,6,0,o.back_button_visible),n(t,11,0,"button");var e=n(t,14,0,"fas","route");n(t,13,0,e,"1x"),n(t,18,0,"button"),n(t,20,0,"ios-qr-scanner","md-qr-scanner"),n(t,24,0,o.progress_bar),n(t,35,0,!o.isTracking),n(t,39,0,o.isTracking)},function(n,t){n(t,12,0,e.Ab(t,13).renderedIconHTML)})}function L(n){return e.Hb(0,[(n()(),e.qb(0,0,null,null,1,"app-location-tracking",[],null,null,null,H,P)),e.pb(1,114688,null,0,m,[r.Kb,r.Nb,l.a,z.b,a.a,s.a,M.a,C.a,c.a,I.a,u.a,p.a,d.a,g.a,r.b,b.a,_.a],null,null)],function(n,t){n(t,1,0)},null)}var A=e.mb("app-location-tracking",m,L,{},{},[]),O=o("gIcY"),j=o("qxEu");o.d(t,"LocationTrackingPageModuleNgFactory",function(){return G});var G=e.nb(v,[],function(n){return e.xb([e.yb(512,e.j,e.cb,[[8,[y.a,A]],[3,e.j],e.x]),e.yb(4608,x.l,x.k,[e.u,[2,x.t]]),e.yb(4608,O.t,O.t,[]),e.yb(4608,r.c,r.c,[e.z,e.g]),e.yb(4608,r.Jb,r.Jb,[r.c,e.j,e.q]),e.yb(4608,r.Ob,r.Ob,[r.c,e.j,e.q]),e.yb(1073742336,x.b,x.b,[]),e.yb(1073742336,O.r,O.r,[]),e.yb(1073742336,O.e,O.e,[]),e.yb(1073742336,r.Fb,r.Fb,[]),e.yb(1073742336,I.q,I.q,[[2,I.w],[2,I.m]]),e.yb(1073742336,q.f,q.f,[]),e.yb(1073742336,j.a,j.a,[]),e.yb(1073742336,v,v,[]),e.yb(1024,I.k,function(){return[[{path:"",component:m}]]},[])])})}}]);