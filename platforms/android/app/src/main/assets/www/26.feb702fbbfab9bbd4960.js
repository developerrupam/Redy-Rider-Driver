(window.webpackJsonp=window.webpackJsonp||[]).push([[26],{bNZI:function(t,n,o){"use strict";o.r(n);var i=o("CcnG"),e=o("mrSG"),r=o("gTw3"),l=o("ZZ/e"),a=o("23JA"),s=o("UNbJ"),c=o("k82s"),u=o("Ht5U"),p=o("67Y/"),d=function(){function t(t,n,o,i,e,r,l,a,s,c,u){var p=this;this.navCtrl=t,this.plt=n,this.geolocation=o,this.storage=i,this.nativeGeocoder=e,this.backgroundGeolocation=r,this.afAuth=l,this.afs=a,this.localNotifications=s,this.route=c,this.officePoolCarService=u,this.progress_bar=!1,this.directionsService=new google.maps.DirectionsService,this.directionsDisplay=new google.maps.DirectionsRenderer({suppressMarkers:!0}),this.DirectionsWaypoint=[],this.arr=[],this.user=null,this.currentMapTrack=null,this.markers=[],this.isTracking=!1,this.trackedRoute=[],this.previousTracks=[],this.loc=[],this.geoencoderOptions={useLocale:!0,maxResults:5},this.stoppage_list=[],this.start_location="",this.end_location="",this.car_type="",this.route_id="",this.driver_id="",console.log("constructor"),this.car_id=this.route.snapshot.params.car_id,this.driver_id=this.route.snapshot.params.driver_id,this.storage.get("car_details").then(function(t){t&&t.forEach(function(t){t.car_id==p.car_id&&(console.log(t),p.route_id=t.route_id,p.stoppage_list=t.stoppage_list,p.start_location=t.start_location,p.end_location=t.end_location,p.car_type=t.car_type,p.loadMap({lat:parseFloat(t.start_lat),lng:parseFloat(t.start_long)},{lat:parseFloat(t.end_lat),lng:parseFloat(t.end_long)}),t.stoppage_list_1.forEach(function(t){var n;n={location:{lat:parseFloat(t.location.lat),lng:parseFloat(t.location.lng)},stopover:t.stopover},p.DirectionsWaypoint.push(n)}),p.ride_startTime=parseFloat(t.start_end_time.start_time),p.ride_endTime=parseFloat(t.start_end_time.end_time))})}),this.storage.get("USER_INFO").then(function(t){t&&p.anonLogin(t.user_account_no+"-"+t.name+"-"+new Date)})}return t.prototype.ngOnInit=function(){var t=this;console.log("ngOnInit"),this.backgroundGeolocation.configure({desiredAccuracy:10,stationaryRadius:20,interval:2e3,distanceFilter:30,debug:!0,stopOnTerminate:!1}).then(function(){t.backgroundGeolocation.on(s.b.location).subscribe(function(n){console.log(n),t.driver_current_lat=n.latitude,t.driver_current_lng=n.longitude,t.update_driver_cordinated_to_firebase(),t.backgroundGeolocation.finish()})})},t.prototype.ionViewDidEnter=function(){console.log("ionViewDidEnter"),this.plt.ready().then(function(){})},t.prototype.ionViewWillEnter=function(){console.log("ionViewWillEnter")},t.prototype.loadMap=function(t,n){var o=this;this.map=new google.maps.Map(this.mapElement.nativeElement,{center:{lat:-34.9011,lng:-56.1645},zoom:30,mapTypeId:google.maps.MapTypeId.ROADMAP,disableDefaultUI:!0}),this.geolocation.getCurrentPosition().then(function(t){var n={lat:t.coords.latitude,lng:t.coords.longitude};o.driver_marker=new google.maps.Marker({position:n,map:o.map,icon:"http://tobuekalabya.com/carservice_manage/icon/car_top.png",title:"you are here!"}),o.map.setCenter(n),o.map.setZoom(30)}).catch(function(t){console.log("Error getting location",t)}),this.directionsDisplay.setMap(this.map),console.log("start_loc",this.start_location),this.location_source=t,this.location_destination=n,this.calculateAndDisplayRoute()},t.prototype.calculateAndDisplayRoute=function(){var t=this,n=this;n.directionsService.route({origin:this.location_source,destination:this.location_destination,travelMode:"DRIVING",waypoints:this.DirectionsWaypoint},function(o,i){"OK"===i?(n.directionsDisplay.setDirections(o),t.stoppage_list.forEach(function(n){var o={lat:parseFloat(n.lat),lng:parseFloat(n.lng)};new google.maps.InfoWindow({content:String(n.location_name)}),new google.maps.Marker({position:o,map:t.map,icon:n.icon,title:"you are here!"})})):window.alert("Directions request failed due to "+i)})},t.prototype.anonLogin=function(t){var n=this;this.afAuth.auth.signInAnonymously().then(function(o){n.locationsCollection=n.afs.collection("locations/"+t+"/track",function(t){return t.orderBy("timestamp")}),n.locations=n.locationsCollection.snapshotChanges().pipe(Object(p.a)(function(t){return t.map(function(t){var n=t.payload.doc.data();return e.__assign({id:t.payload.doc.id},n)})})),console.log("this.locations",n.locations),n.locations.subscribe(function(t){console.log("new location: ",t),n.loc=t})})},t.prototype.startTracking=function(){var t=this;if(google.maps.LatLng(this.driver_current_lat,this.driver_current_lng)==this.location_source){var n=new Date;if(console.log("Current Date ",n.getHours()),console.log("ride time"),this.ride_startTime>=n.getHours()){this.isTracking=!0,this.geolocation.getCurrentPosition().then(function(n){var o={};o.lat=n.coords.latitude,o.long=n.coords.longitude,o.name="";var i=t.car_type+"-"+t.car_id;t.afs.collection("locations").doc(i).set(o)}).catch(function(t){console.log("Error getting location",t)}),this.backgroundGeolocation.start();var o=1;this.trackedRoute=[],this.watch=this.geolocation.watchPosition({frequency:3e3,enableHighAccuracy:!0}).subscribe(function(n){if(console.log("new position: ",n),n){t.trackedRoute.push({lat:n.coords.latitude,lng:n.coords.longitude,address:t.geoAddress,point_number:o}),o++,t.driver_current_lat=n.coords.latitude,t.driver_current_lng=n.coords.longitude;var i=new google.maps.LatLng(t.driver_current_lat,t.driver_current_lng);console.log(i),t.driver_marker.setPosition(i),t.map.panTo(i),t.update_driver_cordinated_to_firebase()}}),this.sendNotificationToPassengers()}else alert("Please Start the ride within the alloted time!")}else alert("The Driver must Start the ride from the Starting point of the route!")},t.prototype.update_driver_cordinated_to_firebase=function(){var t={};t.lat=this.driver_current_lat,t.long=this.driver_current_lng,t.name="test1.03.2020";var n=this.car_type+"-"+this.car_id;this.afs.collection("locations").doc(n).update(t)},t.prototype.stopTracking=function(){if(google.maps.LatLng(this.driver_current_lat,this.driver_current_lng)==this.location_source){this.isTracking=!1,this.backgroundGeolocation.stop(),this.watch.unsubscribe();var t=this.car_type+"-"+this.car_id;this.afs.collection("locations").doc(t).delete(),this.endJourney()}else alert("The Driver must End the ride from the Ending point of the route!")},t.prototype.sendNotificationToPassengers=function(){var t=this;this.progress_bar=!0;var n={type:"drive_start",route_id:this.route_id,route_timing_id:0,car_id:this.car_id,driver_id:this.driver_id};console.log("request_data",n),this.officePoolCarService.todayRidesService(n).subscribe(function(n){t.storage.set("drive_history_id",n.result.drive_history_id),t.progress_bar=!1},function(n){t.progress_bar=!1})},t.prototype.endJourney=function(){var t=this;this.progress_bar=!0,this.storage.get("drive_history_id").then(function(n){n&&t.officePoolCarService.todayRidesService({type:"drive_end",drive_history_id:n}).subscribe(function(n){t.progress_bar=!1},function(n){t.progress_bar=!1})})},t}(),g=function(){return function(){}}(),h=o("pMnS"),b=o("bAmN"),_=o("oBZk"),f=o("fNgX"),m=o("Hf/j"),v=o("ZYjt"),y=o("jWFl"),k=o("OOyK"),w=o("ZYCi"),T=o("iw74"),P=o("jKJn"),D=o("xoVG"),M=o("ZgVV"),q=o("cGva"),I=o("Ip0R"),z=o("ZBkt"),C=o("fvl4"),E=i.ob({encapsulation:0,styles:[["#map[_ngcontent-%COMP%]{width:100%;height:550px}#markerLayer[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{animation:.5s infinite alternate pulse;-webkit-animation:.5s infinite alternate pulse;transform-origin:center;-webkit-transform-origin:center}.footer-bus-route-details[_ngcontent-%COMP%]{background:#0a5999;color:#fff;text-align:center;padding:0 10px}ion-toolbar[_ngcontent-%COMP%]{--background:transparent;--color:white}"],b.a],data:{}});function L(t){return i.Hb(0,[(t()(),i.qb(0,0,null,null,1,"ion-progress-bar",[["class","progress_bar"],["type","indeterminate"]],null,null,null,_.wb,_.E)),i.pb(1,49152,null,0,l.ab,[i.h,i.k,i.z],{type:[0,"type"]},null)],function(t,n){t(n,1,0,"indeterminate")},null)}function O(t){return i.Hb(0,[(t()(),i.qb(0,0,null,null,5,"ion-col",[["no-margin",""],["style","font-size: 20px;"]],null,[[null,"click"]],function(t,n,o){var i=!0;return"click"===n&&(i=!1!==t.component.startTracking()&&i),i},_.ab,_.i)),i.pb(1,49152,null,0,l.v,[i.h,i.k,i.z],null,null),(t()(),i.qb(2,0,null,0,2,"fa-icon",[["class","rstar-icon ng-fa-icon"],["size","1x"]],[[8,"innerHTML",1]],null,null,f.b,f.a)),i.pb(3,573440,null,0,m.a,[v.c,m.b],{iconProp:[0,"iconProp"],size:[1,"size"]},null),i.Bb(4,2),(t()(),i.Gb(-1,0,[" START "]))],function(t,n){var o=t(n,4,0,"fas","play-circle");t(n,3,0,o,"1x")},function(t,n){t(n,2,0,i.Ab(n,3).renderedIconHTML)})}function S(t){return i.Hb(0,[(t()(),i.qb(0,0,null,null,5,"ion-col",[["no-margin",""],["style","font-size: 20px;"]],null,[[null,"click"]],function(t,n,o){var i=!0;return"click"===n&&(i=!1!==t.component.stopTracking()&&i),i},_.ab,_.i)),i.pb(1,49152,null,0,l.v,[i.h,i.k,i.z],null,null),(t()(),i.qb(2,0,null,0,2,"fa-icon",[["class","rstar-icon ng-fa-icon"],["size","1x"]],[[8,"innerHTML",1]],null,null,f.b,f.a)),i.pb(3,573440,null,0,m.a,[v.c,m.b],{iconProp:[0,"iconProp"],size:[1,"size"]},null),i.Bb(4,2),(t()(),i.Gb(-1,0,[" STOP "]))],function(t,n){var o=t(n,4,0,"fas","stop-circle");t(n,3,0,o,"1x")},function(t,n){t(n,2,0,i.Ab(n,3).renderedIconHTML)})}function x(t){return i.Hb(0,[i.Eb(402653184,1,{mapElement:0}),(t()(),i.qb(1,0,null,null,1,"app-header",[],null,null,null,y.b,y.a)),i.pb(2,114688,null,0,k.a,[w.m,l.f,T.b,P.a,D.a,u.a,M.a,q.a],null,null),(t()(),i.hb(16777216,null,null,1,null,L)),i.pb(4,16384,null,0,I.j,[i.P,i.L],{ngIf:[0,"ngIf"]},null),(t()(),i.qb(5,0,null,null,2,"ion-content",[],null,null,null,_.bb,_.j)),i.pb(6,49152,null,0,l.w,[i.h,i.k,i.z],null,null),(t()(),i.qb(7,0,[[1,0],["map",1]],0,0,"div",[["id","map"]],null,null,null,null,null)),(t()(),i.qb(8,0,null,null,11,"ion-footer",[["class","footer-bus-route-details"]],null,null,null,_.gb,_.o)),i.pb(9,49152,null,0,l.B,[i.h,i.k,i.z],null,null),(t()(),i.qb(10,0,null,0,9,"ion-grid",[["no-margin",""],["no-paading",""]],null,null,null,_.hb,_.p)),i.pb(11,49152,null,0,l.C,[i.h,i.k,i.z],null,null),(t()(),i.qb(12,0,null,0,3,"ion-row",[["no-margin",""],["text-center",""]],null,null,null,_.zb,_.H)),i.pb(13,49152,null,0,l.kb,[i.h,i.k,i.z],null,null),(t()(),i.hb(16777216,null,0,1,null,O)),i.pb(15,16384,null,0,I.j,[i.P,i.L],{ngIf:[0,"ngIf"]},null),(t()(),i.qb(16,0,null,0,3,"ion-row",[["no-margin",""],["text-center",""]],null,null,null,_.zb,_.H)),i.pb(17,49152,null,0,l.kb,[i.h,i.k,i.z],null,null),(t()(),i.hb(16777216,null,0,1,null,S)),i.pb(19,16384,null,0,I.j,[i.P,i.L],{ngIf:[0,"ngIf"]},null)],function(t,n){var o=n.component;t(n,2,0),t(n,4,0,o.progress_bar),t(n,15,0,!o.isTracking),t(n,19,0,o.isTracking)},null)}function F(t){return i.Hb(0,[(t()(),i.qb(0,0,null,null,1,"app-location-tracking",[],null,null,null,x,E)),i.pb(1,114688,null,0,d,[l.Kb,l.Nb,r.a,T.b,a.a,s.a,z.a,C.a,c.a,w.a,u.a],null,null)],function(t,n){t(n,1,0)},null)}var H=i.mb("app-location-tracking",d,F,{},{},[]),A=o("gIcY"),R=o("qxEu");o.d(n,"LocationTrackingPageModuleNgFactory",function(){return G});var G=i.nb(g,[],function(t){return i.xb([i.yb(512,i.j,i.cb,[[8,[h.a,H]],[3,i.j],i.x]),i.yb(4608,I.l,I.k,[i.u,[2,I.t]]),i.yb(4608,A.t,A.t,[]),i.yb(4608,l.c,l.c,[i.z,i.g]),i.yb(4608,l.Jb,l.Jb,[l.c,i.j,i.q]),i.yb(4608,l.Ob,l.Ob,[l.c,i.j,i.q]),i.yb(1073742336,I.b,I.b,[]),i.yb(1073742336,A.r,A.r,[]),i.yb(1073742336,A.e,A.e,[]),i.yb(1073742336,l.Fb,l.Fb,[]),i.yb(1073742336,w.q,w.q,[[2,w.w],[2,w.m]]),i.yb(1073742336,m.f,m.f,[]),i.yb(1073742336,R.a,R.a,[]),i.yb(1073742336,g,g,[]),i.yb(1024,w.k,function(){return[[{path:"",component:d}]]},[])])})}}]);